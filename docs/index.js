"use strict";
class ComparisonPoset {
    constructor(humanValues) {
        this.humanValues = humanValues;
        this.orderings = new Map();
        this.humanValues.map(v1 => {
            this.humanValues.map(v2 => {
                this.orderings.set(combine_values(v1, v2), Comparison.Unknown);
            });
        });
    }
    comparison(v1, v2) {
        return this.orderings.get(combine_values(v1, v2));
    }
    all_above(v1) {
        return this.humanValues.filter(v2 => this.comparison(v2, v1) == Comparison.GreaterThan);
    }
    all_below(v1) {
        return this.humanValues.filter(v2 => this.comparison(v1, v2) == Comparison.GreaterThan);
    }
    add_greater_than(higher, lower) {
        let higher_and_above = [higher].concat(this.all_above(higher));
        let lower_and_below = [lower].concat(this.all_below(lower));
        higher_and_above.map(v1 => {
            lower_and_below.map(v2 => {
                this._set(v1, v2, Comparison.GreaterThan);
            });
        });
        return this;
    }
    _set(v1, v2, comparison) {
        if (v1 == v2) {
            throw new Error("Values must be different");
        }
        let current = this.comparison(v1, v2);
        if (current != Comparison.Unknown && current != comparison) {
            throw new Error("Comparison disagreement");
        }
        this.orderings.set(combine_values(v1, v2), comparison);
        this.orderings.set(combine_values(v2, v1), flip_comparison(comparison));
    }
    print_valid() {
        return print_assignation(assign_ordering(this));
    }
    _max_rating(value) {
        // 0-indexed, 0 means definitely at the top
        // rating of n means there are n definitely above this
        return this.humanValues.filter(v2 => this.comparison(v2, value) == Comparison.GreaterThan).length;
    }
    ratings(max) {
        let qualifying = this.humanValues.filter(v => this._max_rating(v) < max);
        return qualifying.map(v => new RatingInformation(v, this._max_rating(v), qualifying.filter(w => this.comparison(v, w) == Comparison.Unknown && (v != w))));
    }
}
class RatingInformation {
    constructor(value, rating, unknown_comparisons) {
        this.value = value;
        this.rating = rating;
        this.unknown_comparisons = unknown_comparisons;
    }
}
function assign_ordering(poset) {
    let assignation = new Map();
    poset.humanValues.map(value => assignation.set(value, Math.random()));
    let missmatch = function () {
        // Need to check that if a > b in the poset then a > b in the assignation
        for (let value of poset.humanValues) {
            let below = poset.all_below(value);
            let biggest_below = Math.max(...below.map(v => assignation.get(v)));
            if (assignation.get(value) <= biggest_below) {
                return true;
            }
        }
        return false;
    };
    let counter = 0;
    let max = 100;
    while (missmatch() && counter < max) {
        for (let value of poset.humanValues) {
            let below = poset.all_below(value);
            let biggest_below = Math.max(...below.map(v => assignation.get(v)));
            if (assignation.get(value) <= biggest_below) {
                assignation.set(value, biggest_below + (1 - biggest_below) * Math.random());
            }
        }
        counter++;
    }
    if (counter == max) {
        throw new Error("Timeout");
    }
    return assignation;
}
function print_assignation(assignation) {
    let values = [...assignation.keys()].sort((a, b) => assignation.get(a) - assignation.get(b));
    return values;
}
function combine_values(v1, v2) {
    return v1 + "::" + v2;
}
var Comparison;
(function (Comparison) {
    Comparison[Comparison["GreaterThan"] = 1] = "GreaterThan";
    Comparison[Comparison["LessThanOrEqual"] = -1] = "LessThanOrEqual";
    Comparison[Comparison["Unknown"] = 0] = "Unknown";
})(Comparison || (Comparison = {}));
function flip_comparison(comparison) {
    switch (comparison) {
        case Comparison.GreaterThan:
            return Comparison.LessThanOrEqual;
        case Comparison.LessThanOrEqual:
            return Comparison.GreaterThan;
        case Comparison.Unknown:
            return Comparison.Unknown;
    }
}
let Definitions = {
    "Adventure": "Finding new excitements",
    "Independence": "Living without routine assistance",
    "Appearance": "Beauty, presence, and fashion",
    "Boldness": "Doing what few dare to do",
    "Compassion": "Easing the pains of strangers",
    "Challenge": "Pushing yourself, regardless of the goal",
    "Community": "Being part of a wider group",
    "Competency": "Building skills in a particular field",
    "Visual Arts and Crafts": "Creating or admiring",
    "Curiosity": "Finding new ideas",
    "Determination": "Finishing what you start",
    "Faith": "Connection to something beyond humanity",
    "Fame": "Being known to all",
    "Friendships": "Deep relationships with a select few",
    "Influence": "Power over others",
    "Justice": "Righting the wrongs you see",
    "Kindness": "Supporting the needs of others",
    "Leadership": "People turning to you for guidance",
    "Learning": "Amassing knowledge and skills",
    "Love": "Finding people to share your heart with",
    "Performing Arts": "Attending or performing",
    "Work": "Fulfilling employment",
    "Peace": "Peace within yourself",
    "Pleasure": "Treating yourself well",
    "Poise": "Physical presence",
    "Popularity": "Being liked, but not perhaps known, by a large group",
    "Religion": "The routine and structure, as opposed to Faith",
    "Reputation": "The things strangers know you for",
    "Responsibility": "Being entrusted by others",
    "Stability": "Confidence that next week will be like this week",
    "Sports": "Attending or playing",
    "Keeping Fit": "Exercise for the sake of health",
    "Quiet Hobbies": "Occupied moments of calm",
};
let Values = [];
for (let key in Definitions) {
    Values.push(key);
}
class ValuesGame {
    constructor(max_interest) {
        this.max_interest = max_interest;
        this.poset = new ComparisonPoset(Values);
    }
    of_interest() {
        let rating_info = this.poset.ratings(this.max_interest);
        let valid_competition = rating_info.filter(ri => ri.unknown_comparisons.length > 0);
        if (valid_competition.length == 0) {
            return [false, []];
        }
        let first_choice = rFrom(valid_competition.map(v => [v, 1 / (1 + v.rating)]));
        let second_choice = rFrom(first_choice.unknown_comparisons.map(v => [v, 1 / (1 + this.poset._max_rating(v))]));
        return [true, [first_choice.value, second_choice]];
    }
    choose(v1, v2) {
        this.poset.add_greater_than(v1, v2);
        this.suggest();
    }
    suggest() {
        clear_choice_div();
        let pair = this.of_interest();
        if (pair[0] != false) {
            draw_choice(pair[1][0], pair[1][1]);
        }
        else {
            draw_assignment(this.poset.print_valid().reverse().slice(0, this.max_interest));
        }
    }
}
function clear_choice_div() {
    let div = document.getElementById("comparisons");
    div.innerHTML = "";
}
function draw_assignment(values) {
    let div = document.getElementById("assignment");
    div.innerHTML = `<div class='header'>Your top values, ranked</div>` + values.map(v => `<div class='valueReport'><p>${v}</p><p>${Definitions[v]}</p></div>`).join("\n");
}
function rFrom(weighted) {
    let total = (weighted.map(v => v[1])).reduce((a, b) => a + b);
    let r = Math.random() * total;
    while (r > 0) {
        let popped = weighted.pop();
        r -= popped[1];
        if (r < 0) {
            return popped[0];
        }
    }
    // Should never reach here
    throw new Error("Weighted list was empty");
}
function draw_choice(v1, v2) {
    let div = document.getElementById("comparisons");
    function button(v, w) {
        let b = document.createElement("button");
        b.innerText = v;
        b.addEventListener("click", ev => {
            VG.choose(v, w);
        });
        return b;
    }
    function mini_label(v) {
        let d = document.createElement("div");
        d.innerText = Definitions[v];
        d.classList.add("definition");
        return d;
    }
    let label = document.createElement("div");
    label.classList.add("header");
    label.classList.add("two-wide");
    label.innerHTML = "Choose one";
    clear_choice_div();
    div.appendChild(label);
    div.appendChild(button(v1, v2));
    div.appendChild(button(v2, v1));
    div.appendChild(mini_label(v1));
    div.appendChild(mini_label(v2));
}
let VG = new ValuesGame(2);
function start() {
    VG.suggest();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE1BQU0sZUFBZTtJQUVqQixZQUFxQixXQUFxQjtRQUFyQixnQkFBVyxHQUFYLFdBQVcsQ0FBVTtRQUQxQyxjQUFTLEdBQTRCLElBQUksR0FBRyxFQUFFLENBQUE7UUFFMUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUU7WUFDdEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUU7Z0JBQ3RCLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1lBQ2xFLENBQUMsQ0FBQyxDQUFBO1FBQ04sQ0FBQyxDQUFDLENBQUE7SUFDTixDQUFDO0lBQ0QsVUFBVSxDQUFDLEVBQVUsRUFBRSxFQUFVO1FBQzdCLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBZSxDQUFBO0lBQ25FLENBQUM7SUFDRCxTQUFTLENBQUMsRUFBVTtRQUNoQixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLElBQUksVUFBVSxDQUFDLFdBQVcsQ0FBQyxDQUFBO0lBQzNGLENBQUM7SUFDRCxTQUFTLENBQUMsRUFBVTtRQUNoQixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLElBQUksVUFBVSxDQUFDLFdBQVcsQ0FBQyxDQUFBO0lBQzNGLENBQUM7SUFDRCxnQkFBZ0IsQ0FBQyxNQUFjLEVBQUUsS0FBYTtRQUMxQyxJQUFJLGdCQUFnQixHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQTtRQUM5RCxJQUFJLGVBQWUsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUE7UUFDM0QsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFO1lBQ3RCLGVBQWUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUU7Z0JBQ3JCLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxVQUFVLENBQUMsV0FBVyxDQUFDLENBQUE7WUFDN0MsQ0FBQyxDQUFDLENBQUE7UUFDTixDQUFDLENBQUMsQ0FBQTtRQUNGLE9BQU8sSUFBSSxDQUFBO0lBQ2YsQ0FBQztJQUNELElBQUksQ0FBQyxFQUFVLEVBQUUsRUFBVSxFQUFFLFVBQXNCO1FBQy9DLElBQUksRUFBRSxJQUFJLEVBQUUsRUFBRTtZQUNWLE1BQU0sSUFBSSxLQUFLLENBQUMsMEJBQTBCLENBQUMsQ0FBQTtTQUM5QztRQUNELElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO1FBQ3JDLElBQUksT0FBTyxJQUFJLFVBQVUsQ0FBQyxPQUFPLElBQUksT0FBTyxJQUFJLFVBQVUsRUFBRTtZQUN4RCxNQUFNLElBQUksS0FBSyxDQUFDLHlCQUF5QixDQUFDLENBQUE7U0FDN0M7UUFDRCxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLFVBQVUsQ0FBQyxDQUFBO1FBQ3RELElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsZUFBZSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUE7SUFDM0UsQ0FBQztJQUNELFdBQVc7UUFDUCxPQUFPLGlCQUFpQixDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFBO0lBQ25ELENBQUM7SUFFRCxXQUFXLENBQUMsS0FBYTtRQUNyQiwyQ0FBMkM7UUFDM0Msc0RBQXNEO1FBQ3RELE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsRUFBRSxLQUFLLENBQUMsSUFBSSxVQUFVLENBQUMsV0FBVyxDQUFDLENBQUMsTUFBTSxDQUFBO0lBQ3JHLENBQUM7SUFFRCxPQUFPLENBQUMsR0FBVztRQUVmLElBQUksVUFBVSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQTtRQUV4RSxPQUFPLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLGlCQUFpQixDQUM1QyxDQUFDLEVBQ0QsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsRUFDbkIsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLFVBQVUsQ0FBQyxPQUFPLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FDbEYsQ0FBQyxDQUFBO0lBQ04sQ0FBQztDQUNKO0FBRUQsTUFBTSxpQkFBaUI7SUFDbkIsWUFBcUIsS0FBYSxFQUFXLE1BQWMsRUFBVyxtQkFBNkI7UUFBOUUsVUFBSyxHQUFMLEtBQUssQ0FBUTtRQUFXLFdBQU0sR0FBTixNQUFNLENBQVE7UUFBVyx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQVU7SUFBSSxDQUFDO0NBQzNHO0FBRUQsU0FBUyxlQUFlLENBQUMsS0FBc0I7SUFDM0MsSUFBSSxXQUFXLEdBQUcsSUFBSSxHQUFHLEVBQWtCLENBQUE7SUFDM0MsS0FBSyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFBO0lBQ3JFLElBQUksU0FBUyxHQUFHO1FBQ1oseUVBQXlFO1FBQ3pFLEtBQUssSUFBSSxLQUFLLElBQUksS0FBSyxDQUFDLFdBQVcsRUFBRTtZQUNqQyxJQUFJLEtBQUssR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFBO1lBQ2xDLElBQUksYUFBYSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQWUsQ0FBQyxDQUFDLENBQUE7WUFDakYsSUFBSSxXQUFXLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBZSxJQUFJLGFBQWEsRUFBRTtnQkFDdkQsT0FBTyxJQUFJLENBQUE7YUFDZDtTQUNKO1FBQ0QsT0FBTyxLQUFLLENBQUE7SUFDaEIsQ0FBQyxDQUFBO0lBQ0QsSUFBSSxPQUFPLEdBQUcsQ0FBQyxDQUFBO0lBQ2YsSUFBSSxHQUFHLEdBQUcsR0FBRyxDQUFBO0lBQ2IsT0FBTyxTQUFTLEVBQUUsSUFBSSxPQUFPLEdBQUcsR0FBRyxFQUFFO1FBQ2pDLEtBQUssSUFBSSxLQUFLLElBQUksS0FBSyxDQUFDLFdBQVcsRUFBRTtZQUNqQyxJQUFJLEtBQUssR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFBO1lBQ2xDLElBQUksYUFBYSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQVcsQ0FBQyxDQUFDLENBQUE7WUFDN0UsSUFBSSxXQUFXLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBVyxJQUFJLGFBQWEsRUFBRTtnQkFDbkQsV0FBVyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsYUFBYSxHQUFHLENBQUMsQ0FBQyxHQUFHLGFBQWEsQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFBO2FBQzlFO1NBQ0o7UUFDRCxPQUFPLEVBQUUsQ0FBQTtLQUNaO0lBQ0QsSUFBSSxPQUFPLElBQUksR0FBRyxFQUFFO1FBQ2hCLE1BQU0sSUFBSSxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUE7S0FDN0I7SUFDRCxPQUFPLFdBQVcsQ0FBQTtBQUN0QixDQUFDO0FBRUQsU0FBUyxpQkFBaUIsQ0FBQyxXQUFnQztJQUN2RCxJQUFJLE1BQU0sR0FBRyxDQUFDLEdBQUcsV0FBVyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUUsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQVksR0FBSSxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBWSxDQUFDLENBQUE7SUFDcEgsT0FBTyxNQUFNLENBQUE7QUFDakIsQ0FBQztBQUVELFNBQVMsY0FBYyxDQUFDLEVBQVUsRUFBRSxFQUFVO0lBQzFDLE9BQU8sRUFBRSxHQUFHLElBQUksR0FBRyxFQUFFLENBQUE7QUFDekIsQ0FBQztBQUVELElBQUssVUFFSjtBQUZELFdBQUssVUFBVTtJQUNYLHlEQUFlLENBQUE7SUFBRSxrRUFBb0IsQ0FBQTtJQUFFLGlEQUFXLENBQUE7QUFDdEQsQ0FBQyxFQUZJLFVBQVUsS0FBVixVQUFVLFFBRWQ7QUFFRCxTQUFTLGVBQWUsQ0FBQyxVQUFzQjtJQUMzQyxRQUFRLFVBQVUsRUFBRTtRQUNoQixLQUFLLFVBQVUsQ0FBQyxXQUFXO1lBQ3ZCLE9BQU8sVUFBVSxDQUFDLGVBQWUsQ0FBQTtRQUNyQyxLQUFLLFVBQVUsQ0FBQyxlQUFlO1lBQzNCLE9BQU8sVUFBVSxDQUFDLFdBQVcsQ0FBQTtRQUNqQyxLQUFLLFVBQVUsQ0FBQyxPQUFPO1lBQ25CLE9BQU8sVUFBVSxDQUFDLE9BQU8sQ0FBQTtLQUNoQztBQUNMLENBQUM7QUFHRCxJQUFJLFdBQVcsR0FBRztJQUNkLFdBQVcsRUFBRSx5QkFBeUI7SUFDdEMsY0FBYyxFQUFFLG1DQUFtQztJQUNuRCxZQUFZLEVBQUUsK0JBQStCO0lBQzdDLFVBQVUsRUFBRSwyQkFBMkI7SUFDdkMsWUFBWSxFQUFFLCtCQUErQjtJQUM3QyxXQUFXLEVBQUUsMENBQTBDO0lBQ3ZELFdBQVcsRUFBRSw2QkFBNkI7SUFDMUMsWUFBWSxFQUFFLHVDQUF1QztJQUNyRCx3QkFBd0IsRUFBRSxzQkFBc0I7SUFDaEQsV0FBVyxFQUFFLG1CQUFtQjtJQUNoQyxlQUFlLEVBQUUsMEJBQTBCO0lBQzNDLE9BQU8sRUFBRSx5Q0FBeUM7SUFDbEQsTUFBTSxFQUFFLG9CQUFvQjtJQUM1QixhQUFhLEVBQUUsc0NBQXNDO0lBQ3JELFdBQVcsRUFBRSxtQkFBbUI7SUFDaEMsU0FBUyxFQUFFLDZCQUE2QjtJQUN4QyxVQUFVLEVBQUUsZ0NBQWdDO0lBQzVDLFlBQVksRUFBRSxvQ0FBb0M7SUFDbEQsVUFBVSxFQUFFLCtCQUErQjtJQUMzQyxNQUFNLEVBQUUseUNBQXlDO0lBQ2pELGlCQUFpQixFQUFFLHlCQUF5QjtJQUM1QyxNQUFNLEVBQUUsdUJBQXVCO0lBQy9CLE9BQU8sRUFBRSx1QkFBdUI7SUFDaEMsVUFBVSxFQUFFLHdCQUF3QjtJQUNwQyxPQUFPLEVBQUUsbUJBQW1CO0lBQzVCLFlBQVksRUFBRSxzREFBc0Q7SUFDcEUsVUFBVSxFQUFFLGdEQUFnRDtJQUM1RCxZQUFZLEVBQUUsbUNBQW1DO0lBQ2pELGdCQUFnQixFQUFFLDJCQUEyQjtJQUM3QyxXQUFXLEVBQUUsa0RBQWtEO0lBQy9ELFFBQVEsRUFBRSxzQkFBc0I7SUFDaEMsYUFBYSxFQUFFLGlDQUFpQztJQUNoRCxlQUFlLEVBQUUsMEJBQTBCO0NBQzlDLENBQUE7QUFFRCxJQUFJLE1BQU0sR0FBYSxFQUFFLENBQUE7QUFDekIsS0FBSyxJQUFJLEdBQUcsSUFBSSxXQUFXLEVBQUU7SUFDekIsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQTtDQUNuQjtBQUVELE1BQU0sVUFBVTtJQUVaLFlBQXFCLFlBQW9CO1FBQXBCLGlCQUFZLEdBQVosWUFBWSxDQUFRO1FBQ3JDLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxlQUFlLENBQUMsTUFBTSxDQUFDLENBQUE7SUFDNUMsQ0FBQztJQUNELFdBQVc7UUFDUCxJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUE7UUFDdkQsSUFBSSxpQkFBaUIsR0FBRyxXQUFXLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLG1CQUFtQixDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQTtRQUNuRixJQUFJLGlCQUFpQixDQUFDLE1BQU0sSUFBSSxDQUFDLEVBQUU7WUFDL0IsT0FBTyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQTtTQUNyQjtRQUVELElBQUksWUFBWSxHQUFHLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQzdFLElBQUksYUFBYSxHQUFHLEtBQUssQ0FBQyxZQUFZLENBQUMsbUJBQW1CLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDOUcsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLFlBQVksQ0FBQyxLQUFLLEVBQUUsYUFBYSxDQUFDLENBQUMsQ0FBQTtJQUN0RCxDQUFDO0lBQ0QsTUFBTSxDQUFDLEVBQVUsRUFBRSxFQUFVO1FBQ3pCLElBQUksQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO1FBQ25DLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQTtJQUNsQixDQUFDO0lBQ0QsT0FBTztRQUNILGdCQUFnQixFQUFFLENBQUE7UUFDbEIsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFBO1FBQzdCLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssRUFBRTtZQUNsQixXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO1NBQ3RDO2FBQU07WUFDSCxlQUFlLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFBO1NBQ2xGO0lBQ0wsQ0FBQztDQUNKO0FBRUQsU0FBUyxnQkFBZ0I7SUFDckIsSUFBSSxHQUFHLEdBQUcsUUFBUSxDQUFDLGNBQWMsQ0FBQyxhQUFhLENBQUMsQ0FBQTtJQUNoRCxHQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQTtBQUN2QixDQUFDO0FBRUQsU0FBUyxlQUFlLENBQUMsTUFBZ0I7SUFDckMsSUFBSSxHQUFHLEdBQUcsUUFBUSxDQUFDLGNBQWMsQ0FBQyxZQUFZLENBQUMsQ0FBQTtJQUMvQyxHQUFJLENBQUMsU0FBUyxHQUFHLG1EQUFtRCxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQywrQkFBK0IsQ0FBQyxVQUFXLFdBQW1CLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtBQUNwTCxDQUFDO0FBRUQsU0FBUyxLQUFLLENBQUksUUFBdUI7SUFDckMsSUFBSSxLQUFLLEdBQUcsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7SUFDN0QsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLEtBQUssQ0FBQTtJQUM3QixPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUU7UUFDVixJQUFJLE1BQU0sR0FBRyxRQUFRLENBQUMsR0FBRyxFQUFpQixDQUFBO1FBQzFDLENBQUMsSUFBSSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDZCxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDUCxPQUFPLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQTtTQUNuQjtLQUNKO0lBQ0QsMEJBQTBCO0lBQzFCLE1BQU0sSUFBSSxLQUFLLENBQUMseUJBQXlCLENBQUMsQ0FBQTtBQUM5QyxDQUFDO0FBRUQsU0FBUyxXQUFXLENBQUMsRUFBVSxFQUFFLEVBQVU7SUFDdkMsSUFBSSxHQUFHLEdBQUcsUUFBUSxDQUFDLGNBQWMsQ0FBQyxhQUFhLENBQUMsQ0FBQTtJQUNoRCxTQUFTLE1BQU0sQ0FBQyxDQUFTLEVBQUUsQ0FBUztRQUNoQyxJQUFJLENBQUMsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQ3hDLENBQUMsQ0FBQyxTQUFTLEdBQUcsQ0FBQyxDQUFBO1FBQ2YsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsRUFBRTtZQUM3QixFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtRQUNuQixDQUFDLENBQUMsQ0FBQTtRQUNGLE9BQU8sQ0FBQyxDQUFBO0lBQ1osQ0FBQztJQUVELFNBQVMsVUFBVSxDQUFDLENBQVM7UUFDekIsSUFBSSxDQUFDLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUNyQyxDQUFDLENBQUMsU0FBUyxHQUFJLFdBQW1CLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDckMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUE7UUFDN0IsT0FBTyxDQUFDLENBQUE7SUFDWixDQUFDO0lBQ0QsSUFBSSxLQUFLLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUN6QyxLQUFLLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQTtJQUM3QixLQUFLLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQTtJQUMvQixLQUFLLENBQUMsU0FBUyxHQUFHLFlBQVksQ0FBQTtJQUM5QixnQkFBZ0IsRUFBRSxDQUFBO0lBQ2xCLEdBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUE7SUFDdkIsR0FBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUE7SUFDaEMsR0FBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUE7SUFDaEMsR0FBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtJQUNoQyxHQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFBO0FBQ3BDLENBQUM7QUFFRCxJQUFJLEVBQUUsR0FBRyxJQUFJLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtBQUMxQixTQUFTLEtBQUs7SUFDVixFQUFFLENBQUMsT0FBTyxFQUFFLENBQUE7QUFDaEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImNsYXNzIENvbXBhcmlzb25Qb3NldCB7XG4gICAgb3JkZXJpbmdzOiBNYXA8c3RyaW5nLCBDb21wYXJpc29uPiA9IG5ldyBNYXAoKVxuICAgIGNvbnN0cnVjdG9yKHJlYWRvbmx5IGh1bWFuVmFsdWVzOiBzdHJpbmdbXSkge1xuICAgICAgICB0aGlzLmh1bWFuVmFsdWVzLm1hcCh2MSA9PiB7XG4gICAgICAgICAgICB0aGlzLmh1bWFuVmFsdWVzLm1hcCh2MiA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5vcmRlcmluZ3Muc2V0KGNvbWJpbmVfdmFsdWVzKHYxLCB2MiksIENvbXBhcmlzb24uVW5rbm93bilcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgfVxuICAgIGNvbXBhcmlzb24odjE6IHN0cmluZywgdjI6IHN0cmluZyk6IENvbXBhcmlzb24ge1xuICAgICAgICByZXR1cm4gdGhpcy5vcmRlcmluZ3MuZ2V0KGNvbWJpbmVfdmFsdWVzKHYxLCB2MikpIGFzIENvbXBhcmlzb25cbiAgICB9XG4gICAgYWxsX2Fib3ZlKHYxOiBzdHJpbmcpOiBzdHJpbmdbXSB7XG4gICAgICAgIHJldHVybiB0aGlzLmh1bWFuVmFsdWVzLmZpbHRlcih2MiA9PiB0aGlzLmNvbXBhcmlzb24odjIsIHYxKSA9PSBDb21wYXJpc29uLkdyZWF0ZXJUaGFuKVxuICAgIH1cbiAgICBhbGxfYmVsb3codjE6IHN0cmluZyk6IHN0cmluZ1tdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaHVtYW5WYWx1ZXMuZmlsdGVyKHYyID0+IHRoaXMuY29tcGFyaXNvbih2MSwgdjIpID09IENvbXBhcmlzb24uR3JlYXRlclRoYW4pXG4gICAgfVxuICAgIGFkZF9ncmVhdGVyX3RoYW4oaGlnaGVyOiBzdHJpbmcsIGxvd2VyOiBzdHJpbmcpOiBDb21wYXJpc29uUG9zZXQge1xuICAgICAgICBsZXQgaGlnaGVyX2FuZF9hYm92ZSA9IFtoaWdoZXJdLmNvbmNhdCh0aGlzLmFsbF9hYm92ZShoaWdoZXIpKVxuICAgICAgICBsZXQgbG93ZXJfYW5kX2JlbG93ID0gW2xvd2VyXS5jb25jYXQodGhpcy5hbGxfYmVsb3cobG93ZXIpKVxuICAgICAgICBoaWdoZXJfYW5kX2Fib3ZlLm1hcCh2MSA9PiB7XG4gICAgICAgICAgICBsb3dlcl9hbmRfYmVsb3cubWFwKHYyID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLl9zZXQodjEsIHYyLCBDb21wYXJpc29uLkdyZWF0ZXJUaGFuKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICAgICAgcmV0dXJuIHRoaXNcbiAgICB9XG4gICAgX3NldCh2MTogc3RyaW5nLCB2Mjogc3RyaW5nLCBjb21wYXJpc29uOiBDb21wYXJpc29uKSB7XG4gICAgICAgIGlmICh2MSA9PSB2Mikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVmFsdWVzIG11c3QgYmUgZGlmZmVyZW50XCIpXG4gICAgICAgIH1cbiAgICAgICAgbGV0IGN1cnJlbnQgPSB0aGlzLmNvbXBhcmlzb24odjEsIHYyKVxuICAgICAgICBpZiAoY3VycmVudCAhPSBDb21wYXJpc29uLlVua25vd24gJiYgY3VycmVudCAhPSBjb21wYXJpc29uKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDb21wYXJpc29uIGRpc2FncmVlbWVudFwiKVxuICAgICAgICB9XG4gICAgICAgIHRoaXMub3JkZXJpbmdzLnNldChjb21iaW5lX3ZhbHVlcyh2MSwgdjIpLCBjb21wYXJpc29uKVxuICAgICAgICB0aGlzLm9yZGVyaW5ncy5zZXQoY29tYmluZV92YWx1ZXModjIsIHYxKSwgZmxpcF9jb21wYXJpc29uKGNvbXBhcmlzb24pKVxuICAgIH1cbiAgICBwcmludF92YWxpZCgpOiBzdHJpbmdbXSB7XG4gICAgICAgIHJldHVybiBwcmludF9hc3NpZ25hdGlvbihhc3NpZ25fb3JkZXJpbmcodGhpcykpXG4gICAgfVxuXG4gICAgX21heF9yYXRpbmcodmFsdWU6IHN0cmluZyk6IG51bWJlciB7XG4gICAgICAgIC8vIDAtaW5kZXhlZCwgMCBtZWFucyBkZWZpbml0ZWx5IGF0IHRoZSB0b3BcbiAgICAgICAgLy8gcmF0aW5nIG9mIG4gbWVhbnMgdGhlcmUgYXJlIG4gZGVmaW5pdGVseSBhYm92ZSB0aGlzXG4gICAgICAgIHJldHVybiB0aGlzLmh1bWFuVmFsdWVzLmZpbHRlcih2MiA9PiB0aGlzLmNvbXBhcmlzb24odjIsIHZhbHVlKSA9PSBDb21wYXJpc29uLkdyZWF0ZXJUaGFuKS5sZW5ndGhcbiAgICB9XG5cbiAgICByYXRpbmdzKG1heDogbnVtYmVyKTogUmF0aW5nSW5mb3JtYXRpb25bXSB7XG5cbiAgICAgICAgbGV0IHF1YWxpZnlpbmcgPSB0aGlzLmh1bWFuVmFsdWVzLmZpbHRlcih2ID0+IHRoaXMuX21heF9yYXRpbmcodikgPCBtYXgpXG5cbiAgICAgICAgcmV0dXJuIHF1YWxpZnlpbmcubWFwKHYgPT4gbmV3IFJhdGluZ0luZm9ybWF0aW9uKFxuICAgICAgICAgICAgdixcbiAgICAgICAgICAgIHRoaXMuX21heF9yYXRpbmcodiksXG4gICAgICAgICAgICBxdWFsaWZ5aW5nLmZpbHRlcih3ID0+IHRoaXMuY29tcGFyaXNvbih2LCB3KSA9PSBDb21wYXJpc29uLlVua25vd24gJiYgKHYgIT0gdykpXG4gICAgICAgICkpXG4gICAgfVxufVxuXG5jbGFzcyBSYXRpbmdJbmZvcm1hdGlvbiB7XG4gICAgY29uc3RydWN0b3IocmVhZG9ubHkgdmFsdWU6IHN0cmluZywgcmVhZG9ubHkgcmF0aW5nOiBudW1iZXIsIHJlYWRvbmx5IHVua25vd25fY29tcGFyaXNvbnM6IHN0cmluZ1tdKSB7IH1cbn1cblxuZnVuY3Rpb24gYXNzaWduX29yZGVyaW5nKHBvc2V0OiBDb21wYXJpc29uUG9zZXQpOiBNYXA8c3RyaW5nLCBudW1iZXI+IHtcbiAgICBsZXQgYXNzaWduYXRpb24gPSBuZXcgTWFwPHN0cmluZywgbnVtYmVyPigpXG4gICAgcG9zZXQuaHVtYW5WYWx1ZXMubWFwKHZhbHVlID0+IGFzc2lnbmF0aW9uLnNldCh2YWx1ZSwgTWF0aC5yYW5kb20oKSkpXG4gICAgbGV0IG1pc3NtYXRjaCA9IGZ1bmN0aW9uICgpOiBCb29sZWFuIHtcbiAgICAgICAgLy8gTmVlZCB0byBjaGVjayB0aGF0IGlmIGEgPiBiIGluIHRoZSBwb3NldCB0aGVuIGEgPiBiIGluIHRoZSBhc3NpZ25hdGlvblxuICAgICAgICBmb3IgKGxldCB2YWx1ZSBvZiBwb3NldC5odW1hblZhbHVlcykge1xuICAgICAgICAgICAgbGV0IGJlbG93ID0gcG9zZXQuYWxsX2JlbG93KHZhbHVlKVxuICAgICAgICAgICAgbGV0IGJpZ2dlc3RfYmVsb3cgPSBNYXRoLm1heCguLi5iZWxvdy5tYXAodiA9PiBhc3NpZ25hdGlvbi5nZXQodikgYXMgQ29tcGFyaXNvbikpXG4gICAgICAgICAgICBpZiAoYXNzaWduYXRpb24uZ2V0KHZhbHVlKSBhcyBDb21wYXJpc29uIDw9IGJpZ2dlc3RfYmVsb3cpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cbiAgICBsZXQgY291bnRlciA9IDBcbiAgICBsZXQgbWF4ID0gMTAwXG4gICAgd2hpbGUgKG1pc3NtYXRjaCgpICYmIGNvdW50ZXIgPCBtYXgpIHtcbiAgICAgICAgZm9yIChsZXQgdmFsdWUgb2YgcG9zZXQuaHVtYW5WYWx1ZXMpIHtcbiAgICAgICAgICAgIGxldCBiZWxvdyA9IHBvc2V0LmFsbF9iZWxvdyh2YWx1ZSlcbiAgICAgICAgICAgIGxldCBiaWdnZXN0X2JlbG93ID0gTWF0aC5tYXgoLi4uYmVsb3cubWFwKHYgPT4gYXNzaWduYXRpb24uZ2V0KHYpIGFzIG51bWJlcikpXG4gICAgICAgICAgICBpZiAoYXNzaWduYXRpb24uZ2V0KHZhbHVlKSBhcyBudW1iZXIgPD0gYmlnZ2VzdF9iZWxvdykge1xuICAgICAgICAgICAgICAgIGFzc2lnbmF0aW9uLnNldCh2YWx1ZSwgYmlnZ2VzdF9iZWxvdyArICgxIC0gYmlnZ2VzdF9iZWxvdykgKiBNYXRoLnJhbmRvbSgpKVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNvdW50ZXIrK1xuICAgIH1cbiAgICBpZiAoY291bnRlciA9PSBtYXgpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVGltZW91dFwiKVxuICAgIH1cbiAgICByZXR1cm4gYXNzaWduYXRpb25cbn1cblxuZnVuY3Rpb24gcHJpbnRfYXNzaWduYXRpb24oYXNzaWduYXRpb246IE1hcDxzdHJpbmcsIG51bWJlcj4pOiBzdHJpbmdbXSB7XG4gICAgbGV0IHZhbHVlcyA9IFsuLi5hc3NpZ25hdGlvbi5rZXlzKCldLnNvcnQoKGEsIGIpID0+IChhc3NpZ25hdGlvbi5nZXQoYSkgYXMgbnVtYmVyKSAtIChhc3NpZ25hdGlvbi5nZXQoYikgYXMgbnVtYmVyKSlcbiAgICByZXR1cm4gdmFsdWVzXG59XG5cbmZ1bmN0aW9uIGNvbWJpbmVfdmFsdWVzKHYxOiBzdHJpbmcsIHYyOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiB2MSArIFwiOjpcIiArIHYyXG59XG5cbmVudW0gQ29tcGFyaXNvbiB7XG4gICAgR3JlYXRlclRoYW4gPSAxLCBMZXNzVGhhbk9yRXF1YWwgPSAtMSwgVW5rbm93biA9IDBcbn1cblxuZnVuY3Rpb24gZmxpcF9jb21wYXJpc29uKGNvbXBhcmlzb246IENvbXBhcmlzb24pOiBDb21wYXJpc29uIHtcbiAgICBzd2l0Y2ggKGNvbXBhcmlzb24pIHtcbiAgICAgICAgY2FzZSBDb21wYXJpc29uLkdyZWF0ZXJUaGFuOlxuICAgICAgICAgICAgcmV0dXJuIENvbXBhcmlzb24uTGVzc1RoYW5PckVxdWFsXG4gICAgICAgIGNhc2UgQ29tcGFyaXNvbi5MZXNzVGhhbk9yRXF1YWw6XG4gICAgICAgICAgICByZXR1cm4gQ29tcGFyaXNvbi5HcmVhdGVyVGhhblxuICAgICAgICBjYXNlIENvbXBhcmlzb24uVW5rbm93bjpcbiAgICAgICAgICAgIHJldHVybiBDb21wYXJpc29uLlVua25vd25cbiAgICB9XG59XG5cblxubGV0IERlZmluaXRpb25zID0ge1xuICAgIFwiQWR2ZW50dXJlXCI6IFwiRmluZGluZyBuZXcgZXhjaXRlbWVudHNcIixcbiAgICBcIkluZGVwZW5kZW5jZVwiOiBcIkxpdmluZyB3aXRob3V0IHJvdXRpbmUgYXNzaXN0YW5jZVwiLFxuICAgIFwiQXBwZWFyYW5jZVwiOiBcIkJlYXV0eSwgcHJlc2VuY2UsIGFuZCBmYXNoaW9uXCIsXG4gICAgXCJCb2xkbmVzc1wiOiBcIkRvaW5nIHdoYXQgZmV3IGRhcmUgdG8gZG9cIixcbiAgICBcIkNvbXBhc3Npb25cIjogXCJFYXNpbmcgdGhlIHBhaW5zIG9mIHN0cmFuZ2Vyc1wiLFxuICAgIFwiQ2hhbGxlbmdlXCI6IFwiUHVzaGluZyB5b3Vyc2VsZiwgcmVnYXJkbGVzcyBvZiB0aGUgZ29hbFwiLFxuICAgIFwiQ29tbXVuaXR5XCI6IFwiQmVpbmcgcGFydCBvZiBhIHdpZGVyIGdyb3VwXCIsXG4gICAgXCJDb21wZXRlbmN5XCI6IFwiQnVpbGRpbmcgc2tpbGxzIGluIGEgcGFydGljdWxhciBmaWVsZFwiLFxuICAgIFwiVmlzdWFsIEFydHMgYW5kIENyYWZ0c1wiOiBcIkNyZWF0aW5nIG9yIGFkbWlyaW5nXCIsXG4gICAgXCJDdXJpb3NpdHlcIjogXCJGaW5kaW5nIG5ldyBpZGVhc1wiLFxuICAgIFwiRGV0ZXJtaW5hdGlvblwiOiBcIkZpbmlzaGluZyB3aGF0IHlvdSBzdGFydFwiLFxuICAgIFwiRmFpdGhcIjogXCJDb25uZWN0aW9uIHRvIHNvbWV0aGluZyBiZXlvbmQgaHVtYW5pdHlcIixcbiAgICBcIkZhbWVcIjogXCJCZWluZyBrbm93biB0byBhbGxcIixcbiAgICBcIkZyaWVuZHNoaXBzXCI6IFwiRGVlcCByZWxhdGlvbnNoaXBzIHdpdGggYSBzZWxlY3QgZmV3XCIsXG4gICAgXCJJbmZsdWVuY2VcIjogXCJQb3dlciBvdmVyIG90aGVyc1wiLFxuICAgIFwiSnVzdGljZVwiOiBcIlJpZ2h0aW5nIHRoZSB3cm9uZ3MgeW91IHNlZVwiLFxuICAgIFwiS2luZG5lc3NcIjogXCJTdXBwb3J0aW5nIHRoZSBuZWVkcyBvZiBvdGhlcnNcIixcbiAgICBcIkxlYWRlcnNoaXBcIjogXCJQZW9wbGUgdHVybmluZyB0byB5b3UgZm9yIGd1aWRhbmNlXCIsXG4gICAgXCJMZWFybmluZ1wiOiBcIkFtYXNzaW5nIGtub3dsZWRnZSBhbmQgc2tpbGxzXCIsXG4gICAgXCJMb3ZlXCI6IFwiRmluZGluZyBwZW9wbGUgdG8gc2hhcmUgeW91ciBoZWFydCB3aXRoXCIsXG4gICAgXCJQZXJmb3JtaW5nIEFydHNcIjogXCJBdHRlbmRpbmcgb3IgcGVyZm9ybWluZ1wiLFxuICAgIFwiV29ya1wiOiBcIkZ1bGZpbGxpbmcgZW1wbG95bWVudFwiLFxuICAgIFwiUGVhY2VcIjogXCJQZWFjZSB3aXRoaW4geW91cnNlbGZcIixcbiAgICBcIlBsZWFzdXJlXCI6IFwiVHJlYXRpbmcgeW91cnNlbGYgd2VsbFwiLFxuICAgIFwiUG9pc2VcIjogXCJQaHlzaWNhbCBwcmVzZW5jZVwiLFxuICAgIFwiUG9wdWxhcml0eVwiOiBcIkJlaW5nIGxpa2VkLCBidXQgbm90IHBlcmhhcHMga25vd24sIGJ5IGEgbGFyZ2UgZ3JvdXBcIixcbiAgICBcIlJlbGlnaW9uXCI6IFwiVGhlIHJvdXRpbmUgYW5kIHN0cnVjdHVyZSwgYXMgb3Bwb3NlZCB0byBGYWl0aFwiLFxuICAgIFwiUmVwdXRhdGlvblwiOiBcIlRoZSB0aGluZ3Mgc3RyYW5nZXJzIGtub3cgeW91IGZvclwiLFxuICAgIFwiUmVzcG9uc2liaWxpdHlcIjogXCJCZWluZyBlbnRydXN0ZWQgYnkgb3RoZXJzXCIsXG4gICAgXCJTdGFiaWxpdHlcIjogXCJDb25maWRlbmNlIHRoYXQgbmV4dCB3ZWVrIHdpbGwgYmUgbGlrZSB0aGlzIHdlZWtcIixcbiAgICBcIlNwb3J0c1wiOiBcIkF0dGVuZGluZyBvciBwbGF5aW5nXCIsXG4gICAgXCJLZWVwaW5nIEZpdFwiOiBcIkV4ZXJjaXNlIGZvciB0aGUgc2FrZSBvZiBoZWFsdGhcIixcbiAgICBcIlF1aWV0IEhvYmJpZXNcIjogXCJPY2N1cGllZCBtb21lbnRzIG9mIGNhbG1cIixcbn1cblxubGV0IFZhbHVlczogc3RyaW5nW10gPSBbXVxuZm9yIChsZXQga2V5IGluIERlZmluaXRpb25zKSB7XG4gICAgVmFsdWVzLnB1c2goa2V5KVxufVxuXG5jbGFzcyBWYWx1ZXNHYW1lIHtcbiAgICBwb3NldDogQ29tcGFyaXNvblBvc2V0XG4gICAgY29uc3RydWN0b3IocmVhZG9ubHkgbWF4X2ludGVyZXN0OiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy5wb3NldCA9IG5ldyBDb21wYXJpc29uUG9zZXQoVmFsdWVzKVxuICAgIH1cbiAgICBvZl9pbnRlcmVzdCgpOiBbYm9vbGVhbiwgc3RyaW5nW11dIHtcbiAgICAgICAgbGV0IHJhdGluZ19pbmZvID0gdGhpcy5wb3NldC5yYXRpbmdzKHRoaXMubWF4X2ludGVyZXN0KVxuICAgICAgICBsZXQgdmFsaWRfY29tcGV0aXRpb24gPSByYXRpbmdfaW5mby5maWx0ZXIocmkgPT4gcmkudW5rbm93bl9jb21wYXJpc29ucy5sZW5ndGggPiAwKVxuICAgICAgICBpZiAodmFsaWRfY29tcGV0aXRpb24ubGVuZ3RoID09IDApIHtcbiAgICAgICAgICAgIHJldHVybiBbZmFsc2UsIFtdXVxuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGZpcnN0X2Nob2ljZSA9IHJGcm9tKHZhbGlkX2NvbXBldGl0aW9uLm1hcCh2ID0+IFt2LCAxIC8gKDEgKyB2LnJhdGluZyldKSlcbiAgICAgICAgbGV0IHNlY29uZF9jaG9pY2UgPSByRnJvbShmaXJzdF9jaG9pY2UudW5rbm93bl9jb21wYXJpc29ucy5tYXAodiA9PiBbdiwgMSAvICgxICsgdGhpcy5wb3NldC5fbWF4X3JhdGluZyh2KSldKSlcbiAgICAgICAgcmV0dXJuIFt0cnVlLCBbZmlyc3RfY2hvaWNlLnZhbHVlLCBzZWNvbmRfY2hvaWNlXV1cbiAgICB9XG4gICAgY2hvb3NlKHYxOiBzdHJpbmcsIHYyOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5wb3NldC5hZGRfZ3JlYXRlcl90aGFuKHYxLCB2MilcbiAgICAgICAgdGhpcy5zdWdnZXN0KClcbiAgICB9XG4gICAgc3VnZ2VzdCgpOiB2b2lkIHtcbiAgICAgICAgY2xlYXJfY2hvaWNlX2RpdigpXG4gICAgICAgIGxldCBwYWlyID0gdGhpcy5vZl9pbnRlcmVzdCgpXG4gICAgICAgIGlmIChwYWlyWzBdICE9IGZhbHNlKSB7XG4gICAgICAgICAgICBkcmF3X2Nob2ljZShwYWlyWzFdWzBdLCBwYWlyWzFdWzFdKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZHJhd19hc3NpZ25tZW50KHRoaXMucG9zZXQucHJpbnRfdmFsaWQoKS5yZXZlcnNlKCkuc2xpY2UoMCwgdGhpcy5tYXhfaW50ZXJlc3QpKVxuICAgICAgICB9XG4gICAgfVxufVxuXG5mdW5jdGlvbiBjbGVhcl9jaG9pY2VfZGl2KCkge1xuICAgIGxldCBkaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImNvbXBhcmlzb25zXCIpXG4gICAgZGl2IS5pbm5lckhUTUwgPSBcIlwiXG59XG5cbmZ1bmN0aW9uIGRyYXdfYXNzaWdubWVudCh2YWx1ZXM6IHN0cmluZ1tdKSB7XG4gICAgbGV0IGRpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiYXNzaWdubWVudFwiKVxuICAgIGRpdiEuaW5uZXJIVE1MID0gYDxkaXYgY2xhc3M9J2hlYWRlcic+WW91ciB0b3AgdmFsdWVzLCByYW5rZWQ8L2Rpdj5gICsgdmFsdWVzLm1hcCh2ID0+IGA8ZGl2IGNsYXNzPSd2YWx1ZVJlcG9ydCc+PHA+JHt2fTwvcD48cD4keyhEZWZpbml0aW9ucyBhcyBhbnkpW3ZdfTwvcD48L2Rpdj5gKS5qb2luKFwiXFxuXCIpXG59XG5cbmZ1bmN0aW9uIHJGcm9tPFQ+KHdlaWdodGVkOiBbVCwgbnVtYmVyXVtdKTogVCB7XG4gICAgbGV0IHRvdGFsID0gKHdlaWdodGVkLm1hcCh2ID0+IHZbMV0pKS5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiKVxuICAgIGxldCByID0gTWF0aC5yYW5kb20oKSAqIHRvdGFsXG4gICAgd2hpbGUgKHIgPiAwKSB7XG4gICAgICAgIGxldCBwb3BwZWQgPSB3ZWlnaHRlZC5wb3AoKSBhcyBbVCwgbnVtYmVyXVxuICAgICAgICByIC09IHBvcHBlZFsxXVxuICAgICAgICBpZiAociA8IDApIHtcbiAgICAgICAgICAgIHJldHVybiBwb3BwZWRbMF1cbiAgICAgICAgfVxuICAgIH1cbiAgICAvLyBTaG91bGQgbmV2ZXIgcmVhY2ggaGVyZVxuICAgIHRocm93IG5ldyBFcnJvcihcIldlaWdodGVkIGxpc3Qgd2FzIGVtcHR5XCIpXG59XG5cbmZ1bmN0aW9uIGRyYXdfY2hvaWNlKHYxOiBzdHJpbmcsIHYyOiBzdHJpbmcpIHtcbiAgICBsZXQgZGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJjb21wYXJpc29uc1wiKVxuICAgIGZ1bmN0aW9uIGJ1dHRvbih2OiBzdHJpbmcsIHc6IHN0cmluZyk6IEhUTUxFbGVtZW50IHtcbiAgICAgICAgbGV0IGIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYnV0dG9uXCIpXG4gICAgICAgIGIuaW5uZXJUZXh0ID0gdlxuICAgICAgICBiLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBldiA9PiB7XG4gICAgICAgICAgICBWRy5jaG9vc2UodiwgdylcbiAgICAgICAgfSlcbiAgICAgICAgcmV0dXJuIGJcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBtaW5pX2xhYmVsKHY6IHN0cmluZyk6IEhUTUxFbGVtZW50IHtcbiAgICAgICAgbGV0IGQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpXG4gICAgICAgIGQuaW5uZXJUZXh0ID0gKERlZmluaXRpb25zIGFzIGFueSlbdl1cbiAgICAgICAgZC5jbGFzc0xpc3QuYWRkKFwiZGVmaW5pdGlvblwiKVxuICAgICAgICByZXR1cm4gZFxuICAgIH1cbiAgICBsZXQgbGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpXG4gICAgbGFiZWwuY2xhc3NMaXN0LmFkZChcImhlYWRlclwiKVxuICAgIGxhYmVsLmNsYXNzTGlzdC5hZGQoXCJ0d28td2lkZVwiKVxuICAgIGxhYmVsLmlubmVySFRNTCA9IFwiQ2hvb3NlIG9uZVwiXG4gICAgY2xlYXJfY2hvaWNlX2RpdigpXG4gICAgZGl2IS5hcHBlbmRDaGlsZChsYWJlbClcbiAgICBkaXYhLmFwcGVuZENoaWxkKGJ1dHRvbih2MSwgdjIpKVxuICAgIGRpdiEuYXBwZW5kQ2hpbGQoYnV0dG9uKHYyLCB2MSkpXG4gICAgZGl2IS5hcHBlbmRDaGlsZChtaW5pX2xhYmVsKHYxKSlcbiAgICBkaXYhLmFwcGVuZENoaWxkKG1pbmlfbGFiZWwodjIpKVxufVxuXG5sZXQgVkcgPSBuZXcgVmFsdWVzR2FtZSgyKVxuZnVuY3Rpb24gc3RhcnQoKSB7XG4gICAgVkcuc3VnZ2VzdCgpXG59Il19